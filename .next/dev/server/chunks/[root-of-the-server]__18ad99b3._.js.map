{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/luisc/Documents/PROJETOS/crm-sistema/app/api/relatorios/route.js"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { verificarToken } from '@/lib/auth'\nimport { db } from '@/lib/firebase-admin'\n\n// GET /api/relatorios?tipo=vendas&periodo=mes\nexport async function GET(request) {\n  try {\n    const usuario = await verificarToken(request)\n    if (!usuario) {\n      return NextResponse.json({ erro: 'Não autorizado' }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const tipo = searchParams.get('tipo') || 'vendas'\n    const periodo = searchParams.get('periodo') || 'mes'\n    const dataInicio = searchParams.get('dataInicio')\n    const dataFim = searchParams.get('dataFim')\n\n    let relatorio = {}\n\n    // Calcular datas baseado no período\n    const agora = new Date()\n    let inicio, fim\n\n    if (dataInicio && dataFim) {\n      inicio = new Date(dataInicio)\n      fim = new Date(dataFim)\n    } else {\n      switch (periodo) {\n        case 'hoje':\n          inicio = new Date(agora.setHours(0, 0, 0, 0))\n          fim = new Date()\n          break\n        case 'semana':\n          inicio = new Date(agora.setDate(agora.getDate() - 7))\n          fim = new Date()\n          break\n        case 'mes':\n          inicio = new Date(agora.setMonth(agora.getMonth() - 1))\n          fim = new Date()\n          break\n        case 'trimestre':\n          inicio = new Date(agora.setMonth(agora.getMonth() - 3))\n          fim = new Date()\n          break\n        case 'ano':\n          inicio = new Date(agora.setFullYear(agora.getFullYear() - 1))\n          fim = new Date()\n          break\n        default:\n          inicio = new Date(agora.setMonth(agora.getMonth() - 1))\n          fim = new Date()\n      }\n    }\n\n    if (tipo === 'vendas') {\n      relatorio = await gerarRelatorioVendas(usuario.uid, inicio, fim)\n    } else if (tipo === 'clientes') {\n      relatorio = await gerarRelatorioClientes(usuario.uid, inicio, fim)\n    } else if (tipo === 'leads') {\n      relatorio = await gerarRelatorioLeads(usuario.uid, inicio, fim)\n    } else if (tipo === 'completo') {\n      relatorio = await gerarRelatorioCompleto(usuario.uid, inicio, fim)\n    }\n\n    return NextResponse.json({\n      sucesso: true,\n      tipo,\n      periodo,\n      dataInicio: inicio.toISOString(),\n      dataFim: fim.toISOString(),\n      dados: relatorio\n    })\n\n  } catch (error) {\n    console.error('Erro ao gerar relatório:', error)\n    return NextResponse.json(\n      { erro: 'Erro ao gerar relatório' },\n      { status: 500 }\n    )\n  }\n}\n\n// Gerar relatório de vendas\nasync function gerarRelatorioVendas(userId, inicio, fim) {\n  const vendasRef = db.collection('vendas')\n  const snapshot = await vendasRef\n    .where('userId', '==', userId)\n    .where('criadoEm', '>=', inicio)\n    .where('criadoEm', '<=', fim)\n    .get()\n\n  let totalVendas = 0\n  let totalReceita = 0\n  let vendasPorStatus = {\n    concluida: 0,\n    pendente: 0,\n    cancelada: 0\n  }\n  let vendasPorMes = {}\n  let vendasPorFormaPagamento = {}\n\n  snapshot.forEach(doc => {\n    const venda = doc.data()\n    totalVendas++\n    \n    if (venda.status === 'concluida') {\n      totalReceita += venda.valor || 0\n    }\n\n    vendasPorStatus[venda.status] = (vendasPorStatus[venda.status] || 0) + 1\n\n    // Agrupar por mês\n    const mes = new Date(venda.criadoEm.toDate()).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })\n    vendasPorMes[mes] = (vendasPorMes[mes] || 0) + 1\n\n    // Agrupar por forma de pagamento\n    vendasPorFormaPagamento[venda.formaPagamento] = (vendasPorFormaPagamento[venda.formaPagamento] || 0) + 1\n  })\n\n  return {\n    totalVendas,\n    totalReceita,\n    ticketMedio: totalVendas > 0 ? totalReceita / totalVendas : 0,\n    vendasPorStatus,\n    vendasPorMes,\n    vendasPorFormaPagamento\n  }\n}\n\n// Gerar relatório de clientes\nasync function gerarRelatorioClientes(userId, inicio, fim) {\n  const clientesRef = db.collection('clientes')\n  const snapshot = await clientesRef\n    .where('userId', '==', userId)\n    .where('criadoEm', '>=', inicio)\n    .where('criadoEm', '<=', fim)\n    .get()\n\n  let totalClientes = 0\n  let clientesPorStatus = { ativo: 0, inativo: 0 }\n  let clientesPorMes = {}\n\n  snapshot.forEach(doc => {\n    const cliente = doc.data()\n    totalClientes++\n    clientesPorStatus[cliente.status] = (clientesPorStatus[cliente.status] || 0) + 1\n\n    const mes = new Date(cliente.criadoEm.toDate()).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })\n    clientesPorMes[mes] = (clientesPorMes[mes] || 0) + 1\n  })\n\n  return {\n    totalClientes,\n    clientesPorStatus,\n    clientesPorMes,\n    taxaAtivos: totalClientes > 0 ? (clientesPorStatus.ativo / totalClientes * 100).toFixed(2) : 0\n  }\n}\n\n// Gerar relatório de leads\nasync function gerarRelatorioLeads(userId, inicio, fim) {\n  const leadsRef = db.collection('leads')\n  const snapshot = await leadsRef\n    .where('userId', '==', userId)\n    .where('criadoEm', '>=', inicio)\n    .where('criadoEm', '<=', fim)\n    .get()\n\n  let totalLeads = 0\n  let leadsPorStatus = {}\n  let leadsPorOrigem = {}\n  let leadsPorMes = {}\n\n  snapshot.forEach(doc => {\n    const lead = doc.data()\n    totalLeads++\n\n    leadsPorStatus[lead.status] = (leadsPorStatus[lead.status] || 0) + 1\n    leadsPorOrigem[lead.origem] = (leadsPorOrigem[lead.origem] || 0) + 1\n\n    const mes = new Date(lead.criadoEm.toDate()).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })\n    leadsPorMes[mes] = (leadsPorMes[mes] || 0) + 1\n  })\n\n  return {\n    totalLeads,\n    leadsPorStatus,\n    leadsPorOrigem,\n    leadsPorMes,\n    taxaConversao: totalLeads > 0 ? ((leadsPorStatus.convertido || 0) / totalLeads * 100).toFixed(2) : 0\n  }\n}\n\n// Gerar relatório completo\nasync function gerarRelatorioCompleto(userId, inicio, fim) {\n  const [vendas, clientes, leads] = await Promise.all([\n    gerarRelatorioVendas(userId, inicio, fim),\n    gerarRelatorioClientes(userId, inicio, fim),\n    gerarRelatorioLeads(userId, inicio, fim)\n  ])\n\n  return {\n    vendas,\n    clientes,\n    leads,\n    resumo: {\n      totalReceita: vendas.totalReceita,\n      totalClientes: clientes.totalClientes,\n      totalLeads: leads.totalLeads,\n      totalVendas: vendas.totalVendas\n    }\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}