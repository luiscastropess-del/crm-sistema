"use strict";(()=>{var e={};e.id=9981,e.ids=[9981],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5809:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>O,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var o={};a.r(o),a.d(o,{GET:()=>d});var r=a(9303),n=a(8716),i=a(670),s=a(7070);async function d(e){try{let t,a,o;let r=await Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}())(e);if(!r)return s.NextResponse.json({erro:"N\xe3o autorizado"},{status:401});let{searchParams:n}=new URL(e.url),i=n.get("tipo")||"clientes",d=n.get("formato")||"csv",l=n.get("dataInicio"),p=n.get("dataFim"),m=n.get("status"),f=[];if("relatorio-completo"===i){let[e,t,a,o]=await Promise.all([u("clientes",r.uid,l,p,m),u("leads",r.uid,l,p,m),u("vendas",r.uid,l,p,m),u("tarefas",r.uid,l,p,m)]);f="json"===d?{clientes:e,leads:t,vendas:a,tarefas:o}:[...e.map(e=>({tipo:"Cliente",...e})),...t.map(e=>({tipo:"Lead",...e})),...a.map(e=>({tipo:"Venda",...e})),...o.map(e=>({tipo:"Tarefa",...e}))]}else f=await u(i,r.uid,l,p,m);return"json"===d?(t=JSON.stringify(f,null,2),a="application/json",o="json"):"csv"===d?(t=c(f),a="text/csv",o="csv"):"excel"===d&&(t=c(f),a="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",o="xlsx"),await Object(function(){var e=Error("Cannot find module '@/lib/firebase-admin'");throw e.code="MODULE_NOT_FOUND",e}()).collection("atividades").add({userId:r.uid,tipo:"exportacao",descricao:`Exportou ${i} em formato ${d}`,metadados:{tipo:i,formato:d,quantidade:Array.isArray(f)?f.length:0},criadoEm:new Date}),new s.NextResponse(t,{headers:{"Content-Type":a,"Content-Disposition":`attachment; filename="${i}_${new Date().toISOString().split("T")[0]}.${o}"`}})}catch(e){return console.error("Erro ao exportar:",e),s.NextResponse.json({erro:"Erro ao exportar dados"},{status:500})}}async function u(e,t,a,o,r){let n=Object(function(){var e=Error("Cannot find module '@/lib/firebase-admin'");throw e.code="MODULE_NOT_FOUND",e}()).collection(e).where("userId","==",t);if(a&&(n=n.where("criadoEm",">=",new Date(a))),o){let e=new Date(o);e.setHours(23,59,59,999),n=n.where("criadoEm","<=",e)}return r&&"todos"!==r&&(n=n.where("status","==",r)),(await n.get()).docs.map(e=>({id:e.id,...e.data(),criadoEm:e.data().criadoEm?.toDate?.()?.toISOString()||e.data().criadoEm,atualizadoEm:e.data().atualizadoEm?.toDate?.()?.toISOString()||e.data().atualizadoEm}))}function c(e){if(!e||0===e.length)return"Nenhum dado encontrado";let t=[...new Set(e.flatMap(e=>Object.keys(e)))];return[t.join(","),...e.map(e=>t.map(t=>{let a=e[t];return null==a?"":("object"==typeof a&&(a=JSON.stringify(a)),((a=String(a).replace(/"/g,'""')).includes(",")||a.includes('"')||a.includes("\n"))&&(a=`"${a}"`),a)}).join(","))].join("\n")}(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/firebase-admin'");throw e.code="MODULE_NOT_FOUND",e}();let l=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/exportar/route",pathname:"/api/exportar",filename:"route",bundlePath:"app/api/exportar/route"},resolvedPagePath:"C:\\Users\\luisc\\Documents\\PROJETOS\\crm-sistema\\app\\api\\exportar\\route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:f}=l,O="/api/exportar/route";function h(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[9276,5972],()=>a(5809));module.exports=o})();